@page "/auth"
@layout AutoRag.Presentation.Web.Shared.LandingLayout
@using AutoRag.Application.DTOs
@using AutoRag.Application.Interfaces
@using AutoRag.Presentation.Web.ViewModels
@inject IAuthService AuthSvc
@inject NavigationManager Nav

<PageTitle>Authentication</PageTitle>

<link href="css/landing.css" rel="stylesheet" />

<div class="auth-container d-flex justify-center align-center">
    <MudPaper Class="pa-6" Style="max-width:450px; width:100%">
        <MudTabs ActivePanelIndex="_tabIndex"
                 OnActivePanelIndexChanged="TabChanged"
                 Rounded="true">

            <MudTabPanel Text="Register">
                <MudForm @ref="_regForm">
                    <MudTextField @bind-Value="_vm.FullName" Label="Full name" Required="true" />
                    <MudTextField @bind-Value="_vm.Email" Label="Email" Required="true" />
                    <MudTextField @bind-Value="_vm.Password" Label="Password"
                                   InputType="InputType.Password" Required="true" />
                    <div class="d-flex justify-center mt-4">
                        <MudButton Color="Color.Primary" Disabled="_vm.IsBusy" OnClick="Register">
                            Register
                        </MudButton>
                    </div>
                </MudForm>
                @Message()
            </MudTabPanel>

            <MudTabPanel Text="Login">
                <MudForm @ref="_loginForm">
                    <MudTextField @bind-Value="_vm.Email" Label="Email" Required="true" />
                    <MudTextField @bind-Value="_vm.Password" Label="Password"
                                   InputType="InputType.Password" Required="true" />
                    <div class="d-flex justify-center mt-4">
                        <MudButton Color="Color.Primary" Disabled="_vm.IsBusy" OnClick="Login">
                            Login
                        </MudButton>
                    </div>
                </MudForm>
                @Message()
            </MudTabPanel>

        </MudTabs>
    </MudPaper>
</div>

@code {
    private readonly AuthPageVm _vm = new();
    private int _tabIndex;

    private MudForm _regForm   = default!;
    private MudForm _loginForm = default!;

    private RenderFragment Message() => @<div class="mt-2 d-flex justify-center">
        @if (_vm.IsBusy)
        {
            <MudProgressCircular Indeterminate="true" />
        }
        else if (_vm.Message is not null)
        {
            <MudAlert Severity="Severity.Info">@_vm.Message</MudAlert>
        }
    </div>;

    private void TabChanged(int idx) { _tabIndex = idx; }

    private async Task Register()
    {
        await _regForm.Validate();
        if (!_regForm.IsValid) return;

        _vm.IsBusy = true;
        var res = await AuthSvc.RegisterAsync(new RegisterDto(_vm.FullName!, _vm.Email, _vm.Password));
        _vm.Message = res.Message;
        _vm.IsBusy = false;

        if (!string.IsNullOrEmpty(res.UserId))
            Nav.NavigateTo("/home");
    }

    private async Task Login()
    {
        await _loginForm.Validate();
        if (!_loginForm.IsValid) return;

        _vm.IsBusy = true;
        var res = await AuthSvc.LoginAsync(new LoginDto(_vm.Email, _vm.Password));
        _vm.Message = res.Message;
        _vm.IsBusy = false;

        if (!string.IsNullOrEmpty(res.UserId))
            Nav.NavigateTo("/home");
    }
}

<style>
    .auth-container {
        height: 100vh;
    }
</style>